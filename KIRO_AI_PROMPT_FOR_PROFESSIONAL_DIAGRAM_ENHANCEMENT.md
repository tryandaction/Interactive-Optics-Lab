# Kiro AI 提示词：专业绘图模式深度完善

## 项目背景

### 项目概述
这是一个基于浏览器的交互式光学实验平台（Interactive Optics Lab），专为光学课题组设计。项目采用纯前端架构，使用 HTML5 Canvas 进行图形渲染，支持可视化光学仿真和专业级光路图绘制。

**在线地址**: https://tryandaction.github.io/Interactive-Optics-Lab

### 核心功能
1. **模拟模式（Simulation Mode）**：交互式光学模拟，实时光线追踪和动画
2. **专业绘图模式（Professional Diagram Mode）**：专业光路图绘制，优化的符号渲染和导出功能

### 技术栈
- **前端框架**: 纯 JavaScript ES6+ Modules
- **图形渲染**: HTML5 Canvas 2D API
- **数据存储**: LocalStorage（浏览器本地存储）
- **图标格式**: SVG（矢量图形）
- **导出格式**: SVG, PNG (高DPI), PDF

### 项目结构
```
Interactive-Optics-Lab/
├── src/
│   ├── core/               # 核心类（Vector, Ray, GameObject, OpticalComponent）
│   ├── components/         # 光学元件（光源、反射镜、透镜、偏振器件、探测器等）
│   ├── simulation/         # 模拟引擎（光线追踪、游戏循环）
│   ├── rendering/          # 渲染模块（光线渲染、网格渲染）
│   ├── diagram/            # 专业绘图模式模块 ⭐ 本次优化重点
│   │   ├── ModeManager.js              # 模式管理器
│   │   ├── ProfessionalIconManager.js  # 专业图标管理器
│   │   ├── ConnectionPointManager.js   # 连接点管理器
│   │   ├── RayLinkManager.js           # 光线链接管理器
│   │   ├── ProfessionalLabelSystem.js  # 专业标注系统
│   │   ├── TechnicalNotesArea.js       # 技术说明区域
│   │   ├── AutoRouter.js               # 自动布线
│   │   ├── ExportEngine.js             # 导出引擎
│   │   └── ... (其他模块)
│   ├── managers/           # 管理器（历史、场景、项目管理）
│   ├── ui/                 # UI模块（事件处理、工具栏、检查器）
│   └── utils/              # 工具函数
└── presets/                # 预设场景
```

---

## 当前问题分析

### 已实现的功能
根据现有代码分析，专业绘图模式已经实现了以下功能：

1. ✅ **模式切换系统** (`ModeManager.js`)
   - 在模拟模式和绘图模式之间切换
   - 状态快照和持久化

2. ✅ **专业图标管理器** (`ProfessionalIconManager.js`)
   - 内置 3D 风格光学元件图标绘制函数
   - SVG 图标加载和缓存
   - 图标分类管理

3. ✅ **连接点系统** (`ConnectionPointManager.js`)
   - 元件连接点定义和管理
   - 连接点世界坐标计算
   - 自定义连接点支持

4. ✅ **光线链接系统** (`RayLinkManager.js`)
   - 手动连接光路（替代物理模拟）
   - 路径点（waypoints）支持
   - 链接样式配置

5. ✅ **自动布线** (`AutoRouter.js`)
   - 正交、对角、直线、曲线布线
   - 障碍物避让

6. ✅ **标注系统** (`ProfessionalLabelSystem.js`)
   - 颜色编码标注
   - 上下标、希腊字母支持

7. ✅ **导出功能** (`ExportEngine.js`)
   - SVG/PNG/PDF 导出
   - 高 DPI 支持

8. ✅ **模板系统** (`DiagramTemplateSystem.js`)
   - 预设模板（Mach-Zehnder、MOT 等）
   - 模板保存和加载

### 核心问题
尽管已经实现了大量功能，但根据用户反馈和参考图片（专业学术论文中的光路图），**当前系统仍然无法轻松绘制出专业级光路图**。主要问题包括：

#### 1. 图标质量和风格不统一
**问题描述**：
- 内置图标使用 Canvas 绘制函数，风格简单，缺乏专业感
- 没有真正集成高质量的 SVG 图标库（如 ComponentLibrary from gwoptics.de）
- 图标样式不够精细，缺少 3D 立体感和材质质感
- 不同类型元件的图标风格不统一

**参考标准**（见用户提供的图片）：
- 反射镜应该有明显的镀膜效果和厚度感
- 透镜应该有曲面光学效果
- AOM/EOM 应该有晶体质感
- 原子气室应该有玻璃容器的透明感
- 磁线圈应该有线圈缠绕的细节

#### 2. 连接点系统不够直观
**问题描述**：
- 连接点在非悬停状态下不够明显
- 连接点的方向指示不清晰
- 缺少连接点的智能吸附反馈
- 没有连接点的快速编辑工具

**期望功能**：
- 悬停元件时自动高亮所有可用连接点
- 连接点应该有清晰的输入/输出方向箭头
- 拖拽创建链接时，应该有明显的吸附动画
- 支持快速添加/删除/编辑自定义连接点

#### 3. 光线链接功能不够灵活
**问题描述**：
- 手动添加路径点（waypoints）的交互不够流畅
- 缺少智能路径优化
- 光线样式预设不够丰富
- 没有光线分支的可视化支持（如分束器的多输出）

**期望功能**：
- 双击链接自动添加路径点
- 拖拽路径点实时调整
- 一键优化路径（去除冗余点）
- 支持光线颜色渐变（表示波长变化）
- 支持光线强度可视化（线宽或透明度）

#### 4. 标注系统功能不完整
**问题描述**：
- 标注的自动定位算法不够智能，经常重叠
- 缺少引线（leader line）的自动路由
- 不支持多行文本和复杂格式
- 缺少标注模板和快速输入

**期望功能**：
- 智能标注定位，避免与元件和光路重叠
- 引线自动避让障碍物
- 支持富文本格式（粗体、斜体、颜色、字号）
- 支持 LaTeX 数学公式
- 标注分组和批量编辑
- 常用标注模板（如 "λ = 780 nm", "f = 100 mm", "P = 10 mW"）

#### 5. 技术说明区域功能简陋
**问题描述**：
- 技术说明区域的排版不够专业
- 缺少多列布局支持
- 不支持表格和列表
- 没有与图表元件的关联

**期望功能**：
- 支持多列布局（如参考图片中的左右分栏）
- 支持表格、列表、代码块
- 支持图例（legend）自动生成
- 支持参数表格（元件名称、参数值、说明）
- 支持注释编号，与图表元件关联

#### 6. 导出质量不够高
**问题描述**：
- PNG 导出的抗锯齿效果不理想
- SVG 导出的文本可能无法正确嵌入字体
- PDF 导出功能不稳定
- 缺少导出预览和质量检查

**期望功能**：
- 高质量抗锯齿渲染
- 字体子集嵌入（确保跨平台显示一致）
- 导出前预览（所见即所得）
- 导出质量检查（分辨率、文件大小、兼容性）
- 批量导出多个场景

#### 7. 交互体验不够流畅
**问题描述**：
- 缺少快捷键支持
- 撤销/重做功能不完整
- 没有多选和批量操作
- 缺少对齐和分布工具
- 没有图层管理

**期望功能**：
- 完整的快捷键系统（Ctrl+C/V/Z/Y, Delete, Esc 等）
- 框选多选
- 批量移动、旋转、缩放、删除
- 对齐工具（左对齐、右对齐、顶对齐、底对齐、水平居中、垂直居中）
- 分布工具（水平均匀分布、垂直均匀分布）
- 图层管理（前置、后置、锁定、隐藏）
- 元件分组

#### 8. 模拟模式与绘图模式的转换不自然
**问题描述**：
- 从模拟模式切换到绘图模式时，光路不能自动转换为链接
- 从绘图模式切换到模拟模式时，链接不能转换为物理光路
- 两种模式的元件表示不一致

**期望功能**：
- 模拟模式 → 绘图模式：自动将追踪的光路转换为链接
- 绘图模式 → 模拟模式：自动将链接转换为光路追踪的起点
- 元件在两种模式下保持一致的位置和参数
- 模式切换时保留用户的编辑状态

#### 9. 缺少专业绘图辅助工具
**问题描述**：
- 没有标尺和网格线
- 缺少测量工具（距离、角度）
- 没有参考线和对齐辅助
- 缺少小地图（minimap）导航

**期望功能**：
- 可配置的网格线（大小、颜色、吸附强度）
- 标尺（显示实际尺寸或像素）
- 测量工具（点击两点显示距离和角度）
- 智能参考线（拖动元件时自动显示对齐线）
- 小地图（显示整个画布，支持快速导航）
- 缩放工具（放大镜、适应窗口、实际大小）

#### 10. 缺少协作和分享功能
**问题描述**：
- 只能导出图片，不能导出可编辑的项目文件
- 没有云端保存和分享
- 缺少版本管理

**期望功能**：
- 导出/导入项目文件（JSON 格式，包含所有元件、链接、标注）
- 导出为可编辑的 SVG（保留图层和元数据）
- 云端保存（可选，使用 GitHub Gist 或其他服务）
- 分享链接（生成只读链接）
- 版本历史（自动保存快照）

---

## 目标定义

### 总体目标
**将专业绘图模式升级为真正的专业级光学实验图绘制工具，使其能够轻松绘制出达到学术论文出版标准的光路图。**

### 具体目标

#### 目标 1：图标系统专业化
**目标描述**：
集成高质量的专业光学元件图标库，使图标达到出版级质量。

**成功标准**：
1. 所有常用光学元件都有高质量的 3D 风格 SVG 图标
2. 图标风格统一，符合学术出版规范
3. 图标支持多种变体（简化版、详细版、彩色版、黑白版）
4. 图标可以自定义颜色、大小、样式
5. 支持用户导入自定义 SVG 图标

**参考资源**：
- ComponentLibrary (gwoptics.de) - 免费开源光学元件 SVG 图标库
- 用户提供的参考图片中的图标风格

#### 目标 2：连接点系统增强
**目标描述**：
优化连接点的可视化和交互，使光路连接更加直观和高效。

**成功标准**：
1. 连接点在悬停时自动高亮，显示清晰的方向指示
2. 拖拽创建链接时有流畅的吸附动画和反馈
3. 支持快速添加/编辑/删除自定义连接点
4. 连接点支持标签和说明
5. 连接点支持类型约束（如只能连接同类型的点）

#### 目标 3：光线链接系统完善
**目标描述**：
增强光线链接的灵活性和可视化效果，支持复杂光路的绘制。

**成功标准**：
1. 支持双击链接添加路径点，拖拽调整路径
2. 支持一键优化路径（去除冗余点、平滑曲线）
3. 支持光线样式丰富配置（颜色、宽度、线型、箭头、渐变）
4. 支持光线分支可视化（分束器多输出）
5. 支持光线强度和偏振态的可视化

#### 目标 4：标注系统专业化
**目标描述**：
实现智能标注系统，支持复杂格式和自动布局。

**成功标准**：
1. 智能标注定位，自动避免重叠
2. 引线自动路由，避让障碍物
3. 支持富文本格式（粗体、斜体、颜色、字号、上下标）
4. 支持 LaTeX 数学公式渲染
5. 支持标注模板和快速输入
6. 支持标注分组和批量编辑

#### 目标 5：技术说明区域专业化
**目标描述**：
实现专业的技术说明区域，支持复杂排版和与图表的关联。

**成功标准**：
1. 支持多列布局
2. 支持表格、列表、代码块
3. 支持图例自动生成
4. 支持参数表格（元件名称、参数值、说明）
5. 支持注释编号，与图表元件关联
6. 支持导出时包含/排除技术说明

#### 目标 6：导出质量提升
**目标描述**：
提升导出质量，确保导出的图像达到出版标准。

**成功标准**：
1. PNG 导出支持高 DPI（300-600 DPI）和高质量抗锯齿
2. SVG 导出正确嵌入字体和样式
3. PDF 导出稳定可靠，支持矢量图形
4. 导出前预览（所见即所得）
5. 导出质量检查和优化建议
6. 批量导出多个场景

#### 目标 7：交互体验优化
**目标描述**：
优化交互体验，提高绘图效率。

**成功标准**：
1. 完整的快捷键系统
2. 框选多选和批量操作
3. 对齐和分布工具
4. 图层管理（前置、后置、锁定、隐藏）
5. 元件分组
6. 撤销/重做功能完善

#### 目标 8：模式转换自然化
**目标描述**：
实现模拟模式与绘图模式的无缝转换。

**成功标准**：
1. 模拟模式 → 绘图模式：自动将光路转换为链接
2. 绘图模式 → 模拟模式：自动将链接转换为光路
3. 元件在两种模式下保持一致
4. 模式切换时保留编辑状态

#### 目标 9：绘图辅助工具完善
**目标描述**：
添加专业绘图辅助工具，提高绘图精度。

**成功标准**：
1. 可配置的网格线和吸附
2. 标尺显示
3. 测量工具（距离、角度）
4. 智能参考线
5. 小地图导航
6. 缩放工具

#### 目标 10：协作和分享功能
**目标描述**：
支持项目文件的导出/导入和分享。

**成功标准**：
1. 导出/导入完整项目文件（JSON）
2. 导出可编辑的 SVG
3. 云端保存（可选）
4. 分享链接
5. 版本历史

---

## 任务描述

### 任务概述
请为"专业绘图模式深度完善"功能创建一个完整的 Spec（规格说明），包括：
1. **Requirements Document（需求文档）**：详细的用户故事和验收标准
2. **Design Document（设计文档）**：技术架构和实现方案
3. **Tasks Document（任务文档）**：可执行的实现任务列表

### 任务要求

#### 1. Requirements Document 要求
- 使用 EARS 模式编写验收标准
- 遵循 INCOSE 质量规则
- 每个需求必须包含：
  - 用户故事（User Story）
  - 验收标准（Acceptance Criteria）
  - 可测试性（Testability）
- 需求必须覆盖上述 10 个目标的所有方面
- 需求必须具体、可测试、可实现

#### 2. Design Document 要求
- 包含系统架构图（使用 Mermaid）
- 详细的组件设计和接口定义
- 数据模型设计
- 正确性属性（Correctness Properties）定义
- 错误处理策略
- 测试策略（单元测试 + 属性测试）

#### 3. Tasks Document 要求
- 任务必须是可执行的代码任务
- 任务必须按模块化方式组织
- 每个任务必须引用对应的需求
- 任务必须包含测试子任务
- 任务必须有明确的完成标准

### 特别注意事项

#### 关于图标系统
1. **必须**集成真实的 SVG 图标库（如 ComponentLibrary），而不是仅仅使用 Canvas 绘制函数
2. 图标必须支持多种风格和变体
3. 图标必须可以自定义颜色和样式
4. 必须支持用户导入自定义 SVG 图标

#### 关于连接点系统
1. 连接点必须在视觉上清晰可见
2. 连接点必须有明确的方向指示
3. 连接点必须支持智能吸附
4. 必须支持自定义连接点的快速编辑

#### 关于光线链接系统
1. 必须支持路径点的交互式编辑
2. 必须支持自动路径优化
3. 必须支持丰富的光线样式
4. 必须支持光线分支的可视化

#### 关于标注系统
1. 必须实现智能标注定位算法
2. 必须支持引线的自动路由
3. 必须支持富文本和 LaTeX 公式
4. 必须支持标注模板

#### 关于技术说明区域
1. 必须支持多列布局
2. 必须支持表格和列表
3. 必须支持与图表元件的关联
4. 必须支持导出时的灵活配置

#### 关于导出功能
1. 必须确保导出质量达到出版标准
2. 必须支持导出前预览
3. 必须支持批量导出
4. 必须支持多种格式（SVG/PNG/PDF）

#### 关于模式转换
1. 必须实现光路与链接的自动转换
2. 必须保持元件状态的一致性
3. 必须保留用户的编辑状态

#### 关于交互体验
1. 必须实现完整的快捷键系统
2. 必须支持多选和批量操作
3. 必须实现对齐和分布工具
4. 必须实现图层管理

#### 关于绘图辅助工具
1. 必须实现网格线和吸附
2. 必须实现测量工具
3. 必须实现智能参考线
4. 必须实现小地图导航

#### 关于协作和分享
1. 必须支持完整项目文件的导出/导入
2. 必须支持可编辑的 SVG 导出
3. 可选支持云端保存和分享

---

## 参考资料

### 用户提供的参考图片
用户提供了 3 张专业光路图的参考图片，展示了以下特点：

**图片 1：NV Center in Diamond Experiment Setup**
- 清晰的元件图标（APD、滤波器、透镜、二向色镜、原子样品、磁铁等）
- 精确的光路连接
- 专业的标注（波长、焦距、偏振态）
- 坐标系标注
- 实验照片与示意图对比

**图片 2：780TA 复杂光路图**
- 大量光学元件（反射镜、分束器、AOM、原子气室、探测器等）
- 复杂的光路连接和分支
- 详细的标注（AOM 频率、气室编号、探测器标签）
- 底部的技术说明区域（AOM 参数列表、注意事项）
- 虚线表示的辅助光路

**图片 3：Dark matter-THz photon conversion**
- 简洁的示意图风格
- 清晰的光路流程（THz photons → Optical photons → Detection）
- 元件标注（Dielectric haloscope, Cold atomic ensemble, SNSPD）
- 辅助光束标注（Auxiliary beams）
- 坐标系和磁场方向标注
- 图例说明（Mirror (Cu), Dielectric disks (Si)）

### 现有代码库
- `src/diagram/` 目录下的所有模块
- `.kiro/specs/professional-diagram-mode/` 目录下的现有 spec 文档

### 外部资源
- ComponentLibrary (gwoptics.de): https://www.gwoptics.de/ComponentLibrary/
- SVG 图标库和设计规范
- 学术论文中的光路图示例

---

## 输出要求

### 文件结构
请创建或更新以下文件：
```
.kiro/specs/professional-diagram-mode-enhanced/
├── requirements.md    # 需求文档
├── design.md          # 设计文档
└── tasks.md           # 任务文档
```

### 文档质量要求
1. **需求文档**：
   - 每个需求必须有清晰的用户故事
   - 验收标准必须使用 EARS 模式
   - 验收标准必须遵循 INCOSE 质量规则
   - 每个验收标准必须可测试

2. **设计文档**：
   - 必须包含系统架构图
   - 必须包含详细的组件设计
   - 必须包含数据模型设计
   - 必须包含正确性属性定义
   - 必须包含测试策略

3. **任务文档**：
   - 任务必须按模块化方式组织
   - 每个任务必须引用对应的需求
   - 任务必须包含测试子任务
   - 任务必须有明确的完成标准

### 语言要求
- 文档使用中文编写
- 代码注释使用中文
- 变量和函数名使用英文

---

## 开始指令

请基于以上信息，为"专业绘图模式深度完善"功能创建完整的 Spec。

**第一步**：创建 Requirements Document（需求文档）
- 分析上述 10 个目标
- 为每个目标创建详细的需求
- 使用 EARS 模式编写验收标准
- 确保所有需求可测试

**第二步**：创建 Design Document（设计文档）
- 设计系统架构
- 设计组件接口
- 设计数据模型
- 定义正确性属性
- 制定测试策略

**第三步**：创建 Tasks Document（任务文档）
- 将设计分解为可执行任务
- 为每个任务添加测试子任务
- 确保任务的可追溯性

请开始创建 Spec！
