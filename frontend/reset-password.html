<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>重置密码 - 交互式光学实验室</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div style="display: flex; justify-content: center; align-items: center; min-height: 100vh; background: var(--bg-color);">
        <div style="background: var(--panel-bg); padding: 40px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); width: 100%; max-width: 400px;">
            <h2 style="text-align: center; margin-bottom: 30px; color: var(--text-color);">重置密码</h2>

            <form id="reset-password-form">
                <div class="form-group" style="margin-bottom: 20px;">
                    <label for="reset-password" style="display: block; margin-bottom: 5px; color: var(--text-color);">新密码:</label>
                    <input type="password" id="reset-password" required placeholder="请输入新密码（至少6位）" style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 5px; background: var(--input-bg); color: var(--text-color);">
                </div>

                <div class="form-group" style="margin-bottom: 20px;">
                    <label for="reset-password-confirm" style="display: block; margin-bottom: 5px; color: var(--text-color);">确认密码:</label>
                    <input type="password" id="reset-password-confirm" required placeholder="请再次输入新密码" style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 5px; background: var(--input-bg); color: var(--text-color);">
                </div>

                <button type="submit" style="width: 100%; padding: 12px; background: var(--primary-color); color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 16px;">重置密码</button>

                <p id="reset-error" class="error-text" style="display: none; margin-top: 15px; color: #e74c3c; text-align: center;"></p>

                <p style="text-align: center; margin-top: 20px; color: var(--secondary-color);">
                    <a href="index.html" style="color: var(--primary-color);">返回登录</a>
                </p>
            </form>
        </div>
    </div>

    <script src="user.js"></script>
    <script>
        // 重写用户管理器初始化，专门用于密码重置页面
        document.addEventListener('DOMContentLoaded', () => {
            // 创建一个简化的用户管理器实例，只处理密码重置
            const resetUserManager = {
                apiBaseUrl: 'http://localhost:3000/api',

                async handleResetPassword() {
                    const newPassword = document.getElementById('reset-password').value;
                    const confirmPassword = document.getElementById('reset-password-confirm').value;
                    const errorElement = document.getElementById('reset-error');

                    if (!newPassword || !confirmPassword) {
                        this.showError(errorElement, '请填写所有字段');
                        return;
                    }

                    if (newPassword.length < 6) {
                        this.showError(errorElement, '密码长度至少6位');
                        return;
                    }

                    if (newPassword !== confirmPassword) {
                        this.showError(errorElement, '两次输入的密码不一致');
                        return;
                    }

                    // 从URL获取令牌和用户ID
                    const urlParams = new URLSearchParams(window.location.search);
                    const token = urlParams.get('token');
                    const userId = urlParams.get('userId');

                    if (!token || !userId) {
                        this.showError(errorElement, '重置令牌无效，请重新请求密码重置');
                        return;
                    }

                    try {
                        const response = await this.apiRequest('/auth/reset-password', {
                            method: 'POST',
                            body: JSON.stringify({
                                userId: userId,
                                token: token,
                                newPassword: newPassword
                            }),
                            headers: {
                                'Content-Type': 'application/json'
                            }
                        });

                        if (response.success) {
                            this.showSuccess('密码重置成功，即将跳转到登录页面...');
                            setTimeout(() => {
                                window.location.href = 'index.html';
                            }, 2000);
                        } else {
                            this.showError(errorElement, response.message || '密码重置失败');
                        }
                    } catch (error) {
                        console.error('Reset password error:', error);
                        this.showError(errorElement, '网络错误，请稍后重试');
                    }
                },

                async apiRequest(endpoint, options = {}) {
                    const url = this.apiBaseUrl + endpoint;
                    const response = await fetch(url, {
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        ...options
                    });

                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({}));
                        throw new Error(errorData.message || `HTTP error! status: ${response.status}`);
                    }

                    return await response.json();
                },

                showError(element, message) {
                    if (element) {
                        element.textContent = message;
                        element.style.display = 'block';
                        setTimeout(() => {
                            element.style.display = 'none';
                        }, 5000);
                    }
                },

                showSuccess(message) {
                    console.log('Success:', message);
                    // 可以在这里添加成功提示的UI
                }
            };

            // 绑定表单提交事件
            const resetPasswordForm = document.getElementById('reset-password-form');
            if (resetPasswordForm) {
                resetPasswordForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    resetUserManager.handleResetPassword();
                });
            }

            // 检查URL中的令牌
            const urlParams = new URLSearchParams(window.location.search);
            const token = urlParams.get('token');
            const userId = urlParams.get('userId');

            if (!token || !userId) {
                resetUserManager.showError(
                    document.getElementById('reset-error'),
                    '无效的重置链接，请重新请求密码重置'
                );
            }
        });
    </script>
</body>
</html>