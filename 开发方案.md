# 交互式光学实验室 - 产品开发方案 (v0.7)

**最终目标:** 开发一个功能强大、物理精确、界面美观、交互流畅、易于使用的跨平台光学仿真工具，特别侧重于原子分子光物理(AMO)和量子精密测量等现代光学实验的模拟，适用于教育教学、科研初步验证、光学设计演示等场景。

**核心原则:**

* 追求完美、注重细节
* 用户体验优先
* 物理准确性与性能平衡
* 分阶段迭代开发
* **专业界面对标:** 借鉴成熟CAD/CAE软件的界面布局和交互逻辑，提升专业感和操作效率。

**开发阶段划分:**

**第一阶段：核心功能完善与体验优化 (已基本完成)**

* **目标:** 巩固核心功能，修复问题，优化交互体验。
* **任务列表:**
    * **[已完成]** 基本元件库（光源、镜、片、屏、块、缝、栅、偏振、波片、AOM、光纤、探测器等）。
    * **[已完成]** 核心物理模拟（反射、折射、色散、衍射基础、偏振基础、干涉基础）。
    * **[已完成]** 完整的操作历史与撤销/重做 (Undo/Redo) 功能。
    * **[已完成]** 元件单选/多选、移动、旋转、删除。
    * **[已完成]** 专业的UI框架（顶部菜单栏、右侧带标签页的检查器面板）。
    * **[已完成]** 画布缩放、平移。
    * **[已完成]** 场景本地保存/加载/管理。
    * **[已完成]** 模式切换（光线追踪 vs 透镜成像）。
    * **[已完成]** 全局设置面板（网格、光线数、弹射数、强度阈值等）。

**第二阶段：非物理功能开发与用户体验优化 (当前焦点)**

* **目标:** 优先开发用户系统、界面优化、交互增强等"非物理"功能，提升用户体验和产品完整性。
* **任务列表:**

    * **[高优先级] 用户系统与云同步:**
        * **用户注册登录系统:** ✅ 实现完整的用户认证流程，包括邮箱验证、密码重置、用户资料管理
        * **云端场景存储:** ✅ 用户场景自动同步到云端，支持多设备访问
        * **场景分享功能:** ✅ 用户可分享场景链接给其他用户，支持公开/私有设置
        * **用户偏好设置:** ✅ 保存用户的主题选择、快捷键设置、默认参数等个人偏好
        * **后端API开发:** ✅ 使用Node.js + Express + MongoDB构建RESTful API
        * **前端状态管理:** ✅ 实现用户登录状态管理、token刷新、错误处理

    * **[高优先级] 界面主题与可读性优化:**
        * **用户指南可读性修复:** 确保用户指南在不同主题（白天/黑夜、深色/浅色画布）下文字清晰可读
        * **动态文字颜色适配:** 根据画布背景色自动调整文字颜色，确保对比度足够
        * **主题切换动画:** 添加平滑的主题切换过渡效果
        * **高对比度模式:** 为视觉障碍用户提供高对比度主题选项
        * **字体大小调节:** 允许用户调整界面字体大小

    * **[中优先级] 场景管理增强:**
        * **场景命名与分类:** 支持场景重命名、添加标签、按类别组织
        * **场景搜索功能:** 按名称、标签、创建时间搜索场景
        * **场景预览图:** 自动生成场景缩略图，便于快速识别
        * **批量操作:** 支持批量删除、移动、导出场景
        * **场景模板系统:** 预设常用实验模板，用户可快速创建
        * **场景版本管理:** 保存场景历史版本，支持回滚

    * **[中优先级] 交互功能优化:**
        * **对齐辅助线:** ✅ 拖动元件时显示与其他元件对齐的参考线
        * **智能吸附系统:** ✅ 元件自动吸附到网格点、其他元件边缘、中心点
        * **快捷键系统:** ✅ 完善快捷键支持，包括自定义快捷键
        * **右键菜单:** 为元件和画布添加上下文菜单
        * **拖拽预览:** ✅ 改进拖拽时的视觉反馈
        * **多选操作增强:** ✅ 支持框选、Ctrl+A全选、反选等操作
        * **箭头拖影控制:** ✅ 新增箭头拖影开关，可选择开启/关闭拖影效果

    * **[高优先级] 协作功能开发:**
        * **项目管理UI:** ✅ 实现项目创建、编辑、分享界面
        * **用户内容所有权跟踪:** ✅ 元件创建时记录用户ID
        * **权限控制系统:** ✅ 支持查看者/编辑者权限管理
        * **协作会话管理:** ✅ 项目加入/离开和状态同步
        * **协作者邀请系统:** ✅ 通过邮箱邀请协作者加入项目
        * **内容过滤器:** ✅ 实现用户内容视觉过滤功能
        * **项目场景管理:** ⏳ 项目内场景的创建和管理
        * **操作历史UI:** ⏳ 显示用户的操作历史
        * **协作状态指示器:** ⏳ 显示在线协作者和光标位置
        * **实时协作同步:** ⏳ WebSocket实时同步功能

    * **[中优先级] 帮助系统完善:**
        * **交互式教程:** 为新用户提供分步骤的交互式引导
        * **上下文帮助:** 鼠标悬停显示元件功能说明
        * **快捷键提示:** 界面中显示可用的快捷键
        * **视频教程集成:** 嵌入教学视频链接
        * **FAQ系统:** 常见问题解答和故障排除指南
        * **用户反馈系统:** 集成用户反馈和建议收集

    * **[低优先级] 导入导出功能增强:**
        * **多格式支持:** 支持导出为PNG、SVG、PDF、JSON等格式
        * **批量导出:** 支持批量导出多个场景
        * **导出设置:** 自定义导出分辨率、背景色、水印等
        * **导入优化:** 支持拖拽导入、批量导入、格式验证
        * **数据备份:** 自动备份用户数据到云端

    * **[低优先级] 性能与无障碍优化:**
        * **大场景优化:** 优化包含大量元件的场景性能
        * **内存管理:** ✅ 改进内存使用，防止内存泄漏（修复箭头动画状态泄漏）
        * **响应式设计:** 优化移动设备和平板的使用体验
        * **键盘导航:** 支持完全键盘操作
        * **屏幕阅读器支持:** 为视觉障碍用户提供无障碍访问
        * **多语言支持:** 支持中英文界面切换

**第三阶段：AMO与量子光学元件库扩展**

* **目标:** 丰富元件库，使其能支持搭建典型的AMO和量子精密测量实验光路，并全面提升元件的视觉真实感。

#### 🎯 协作功能详细设计

##### 1. 核心架构设计
```
协作系统架构：
├── 前端组件
│   ├── ProjectManager (项目管理器)
│   ├── CollaborationUI (协作界面)
│   ├── UserFilter (用户内容过滤器)
│   └── RealTimeSync (实时同步)
├── 后端服务
│   ├── Project API (项目CRUD)
│   ├── Collaboration API (协作会话)
│   └── Operation History (操作历史)
└── 数据模型
    ├── Project (项目)
    ├── CollaborationSession (协作会话)
    ├── OperationHistory (操作历史)
    └── ComponentOwnership (元件所有权)
```

##### 2. 用户内容视觉过滤系统

**设计目标：**
- 支持按用户过滤显示元件内容
- 提供高亮/变暗/隐藏三种过滤模式
- 实时响应过滤器变化
- 保持良好的视觉体验

**实现方案：**
```javascript
class UserContentFilter {
    constructor() {
        this.filterMode = 'all'; // 'all', 'mine', userId
        this.dimOtherContent = true;
        this.highlightMyContent = false;
    }

    // 过滤逻辑
    shouldRender(component) {
        if (this.filterMode === 'all') return true;
        if (this.filterMode === 'mine') {
            return component.userId === currentUser.id;
        }
        return component.userId === this.filterMode;
    }

    // 视觉效果应用
    applyVisualEffect(component, ctx) {
        if (!this.shouldRender(component)) {
            if (this.dimOtherContent) {
                ctx.globalAlpha = 0.3; // 变暗
            } else {
                return false; // 隐藏
            }
        } else if (this.highlightMyContent && component.userId === currentUser.id) {
            // 高亮效果
            ctx.shadowColor = '#00ff00';
            ctx.shadowBlur = 5;
        }
        return true;
    }
}
```

**UI设计：**
- 过滤器下拉菜单：显示全部/仅显示我的内容/显示特定用户内容
- 复选框：淡化其他用户内容
- 实时预览：过滤器变化立即生效

##### 3. 实时协作同步系统

**WebSocket通信协议：**
```javascript
// 客户端到服务器
{
    type: 'join_project',
    projectId: 'project_id',
    userId: 'user_id'
}

// 服务器到客户端
{
    type: 'user_joined',
    user: { id, username },
    cursor: { x, y }
}

{
    type: 'component_updated',
    componentId: 'comp_id',
    changes: { ... },
    userId: 'user_id'
}
```

**冲突解决策略：**
- 乐观更新：先应用本地更改，再同步
- 操作转换：处理并发编辑冲突
- 最后写入胜出：简单组件属性更新

##### 4. 协作状态指示器

**设计元素：**
- 在线用户列表：显示当前项目中的活跃用户
- 用户光标：实时显示其他用户的鼠标位置
- 用户颜色标识：每个用户有独特的颜色标识
- 活动状态：显示用户的最后活动时间

**实现方案：**
```javascript
class CollaborationIndicator {
    constructor() {
        this.onlineUsers = new Map();
        this.userColors = new Map();
        this.cursors = new Map();
    }

    // 添加在线用户
    addUser(user) {
        this.onlineUsers.set(user.id, user);
        this.assignColor(user.id);
    }

    // 显示用户光标
    showCursor(userId, position) {
        // 在画布上绘制用户光标
    }

    // 分配用户颜色
    assignColor(userId) {
        const colors = ['#ff0000', '#00ff00', '#0000ff', '#ffff00', '#ff00ff', '#00ffff'];
        const index = this.userColors.size % colors.length;
        this.userColors.set(userId, colors[index]);
    }
}
```

##### 5. 操作历史系统

**功能特性：**
- 记录所有用户的操作历史
- 支持撤销特定用户的操作
- 显示操作时间线
- 按用户过滤历史记录

**数据结构：**
```javascript
{
    projectId: ObjectId,
    userId: ObjectId,
    operation: 'create_component',
    targetType: 'component',
    targetId: 'comp_123',
    beforeState: { ... },
    afterState: { ... },
    timestamp: Date,
    sessionId: ObjectId
}
```

##### 6. 权限控制系统

**权限级别：**
- **所有者 (Owner)**: 完全控制权
  - 创建/编辑/删除项目
  - 邀请/移除协作者
  - 修改项目设置
  - 查看所有操作历史

- **编辑者 (Editor)**: 编辑权限
  - 添加/修改/删除元件
  - 修改场景设置
  - 查看项目内容

- **查看者 (Viewer)**: 只读权限
  - 查看项目和场景
  - 无法修改任何内容
  - 可以导出场景副本

**权限检查逻辑：**
```javascript
function checkPermission(userId, projectId, action) {
    const collaboration = project.collaborators.find(c => c.userId === userId);

    if (project.ownerId === userId) return true; // 所有者

    if (!collaboration) return false; // 非协作者

    switch (action) {
        case 'edit_component':
            return collaboration.permission === 'editor';
        case 'view_project':
            return true; // 所有协作者都可以查看
        case 'invite_users':
            return project.ownerId === userId; // 只有所有者能邀请
        default:
            return false;
    }
}
```

##### 7. 项目场景管理

**功能设计：**
- 项目内场景的层次结构
- 场景模板和快速创建
- 场景版本控制
- 场景间元件引用

**UI设计：**
- 项目场景树形结构
- 场景拖拽排序
- 场景标签页管理
- 场景间导航

##### 8. 性能优化策略

**前端优化：**
- 虚拟滚动：大量元件时的渲染优化
- 增量更新：只重绘变化的元件
- 过滤缓存：避免重复计算过滤结果

**后端优化：**
- 分页查询：大量项目和场景的分页加载
- 索引优化：数据库查询性能
- 缓存策略：热点数据的缓存

**网络优化：**
- 增量同步：只传输变化的数据
- 压缩传输：WebSocket数据压缩
- 连接池：复用WebSocket连接
* **任务列表:**
    * **[进行中]** **元件视觉设计全面升级:**
        * **目标:** 使每个元件在工具栏和画布上的渲染更贴近真实的实验室器件。
        * **示例:**
            * **偏振分束器 (PBS):** 绘制成一个立方体（正方形），中间带有一条45度对角线，并标明反射/透射端口。
            * **反射镜 (Mirror):** 为背面添加更明确的斜线填充。
            * **透镜 (Lens):** 根据焦距正负，更清晰地绘制为双凸或双凹形状。
            * **波片 (Wave Plate):** 在元件上清晰标注快轴方向和类型 (λ/2, λ/4)。
        * **实现:** 重点修改各元件在 `components.js` 中的 `draw(ctx)` 方法和在 `index.html` 中的工具栏SVG图标。

    * **[已完成]** **新增元件：法拉第隔离器 (Faraday Isolator)**
        * **应用:** 激光注入锁定、防止有害光反馈。
        * **视觉设计:** 一个带有表示光线允许单向通过箭头的矩形框。
        * **物理功能 (`interact`):** 允许光线从输入端完美通过。对于从输出端反向入射的光线，则完全吸收或将其偏转出光路（终止光线）。

    * **[已完成]** **新增元件：法拉第旋光器 (Faraday Rotator)**
        * **应用:** 磁场控制的偏振旋转。
        * **视觉设计:** 带有旋转箭头的圆柱体，表示磁场引起的偏振旋转。
        * **物理功能 (`interact`):** 应用法拉第效应，旋转光线的偏振方向。

    * **[已完成]** **新增元件：光隔离器 (Optical Isolator)**
        * **应用:** 保护激光源、防止反馈。
        * **视觉设计:** 组合了偏振片和法拉第旋光器的复合元件。
        * **物理功能 (`interact`):** 实现单向光传输，阻止反向光线通过。

    * **[待办]** **新增元件：电光调制器 (EOM - Electro-Optic Modulator)**
        * **应用:** 激光稳频 (PDH技术)、高速光开关。
        * **视觉设计:** 一个晶体状的矩形，带有射频(RF)输入符号。
        * **物理功能 (`interact`):** 当光线通过时，为其附加一个相位调制。在简化的模型中，可以表现为将单色光分裂成载波和两个边带（三条频率略有差异的光线）。这需要 `Ray` 类支持频率属性或通过波长微小变化来模拟。

    * **[待-办]** **新增元件：原子蒸汽池 (Atomic Vapor Cell)**
        * **应用:** 饱和吸收光谱、原子钟、磁力计。
        * **视觉设计:** 一个玻璃材质感的圆柱体或立方体池，内部可有微弱的颜色示意。
        * **物理功能 (`interact`):** 具有强烈的波长依赖性吸收特性。当入射光波长接近原子共振频率时，光线强度急剧衰减（被吸收）。可以为其设定一个中心波长和吸收线宽。

    * **[待办]** **新增元件：法布里-珀罗标准具 (Fabry-Pérot Etalon/Cavity)**
        * **应用:** 激光稳频、光谱分析、激光器谐振腔。
        * **视觉设计:** 由两片平行放置、具有高反射率的反射镜组成。
        * **物理功能 (`interact`):** 这是一个多光束干涉元件。当光线入射时，会在两镜之间多次反射和透射。只有当光波长满足谐振条件（腔长是半波长的整数倍）时，透射率才接近1，否则透射率极低。这需要一个能处理多次内部反射的复杂 `interact` 方法。

**第四阶段：物理模型深化**

* **目标:** 提高模拟的物理精度，完善现有物理效应。
* **任务列表:**
    * **[待办]** **高斯光束完善:** 精确追踪光束宽度和曲率半径，实现ABCD矩阵变换。
    * **[待办]** **衍射与干涉模型增强:** 实现基于惠更斯原理或傅里叶光学的衍射计算，在屏幕上显示更真实的衍射图样。
    * **[待办]** **偏振模型深化:** 实现菲涅尔方程，模拟布儒斯特角等现象。
    * **[待办]** **透镜像差模拟:** 加入球差、彗差等具体模型。

**第五阶段：高级功能与产品化**

* **目标:** 实现协作、高级导出等高级功能，将其包装成完整的应用。
* **任务列表:**
    * **[待办]** **后端开发与云同步**
    * **[待办]** **单位与标尺系统**
    * **[待办]** **结果导出 (图像/数据)**
    * **[待办]** **性能优化 (Web Workers, WebGL)**
    * **[待办]** **跨平台打包 (Electron/Tauri)**

**实施计划与时间安排:**

**第二阶段详细实施计划 (预计 8-12 周):**

**第1-2周: 用户系统与云同步 (高优先级)**
* 搭建后端API基础设施 (Node.js + Express + MongoDB)
* 实现用户注册、登录、密码重置功能
* 开发前端用户状态管理系统
* 实现基础的云端场景存储功能

**第3-4周: 界面主题与可读性优化 (高优先级)**
* 修复用户指南在不同主题下的可读性问题
* 实现动态文字颜色适配系统
* 添加主题切换动画效果
* 开发高对比度模式

**第5-6周: 场景管理增强 (中优先级)**
* 实现场景命名、分类、标签系统
* 开发场景搜索和过滤功能
* 添加场景预览图生成
* 实现批量操作功能

**第7-8周: 交互功能优化 (中优先级)**
* 开发对齐辅助线和智能吸附系统
* 完善快捷键系统和右键菜单
* 改进多选操作和拖拽体验
* 优化用户交互反馈

**第9-10周: 帮助系统完善 (中优先级)**
* 开发交互式教程系统
* 实现上下文帮助和工具提示
* 集成用户反馈系统
* 完善文档和FAQ

**第11-12周: 测试与优化 (低优先级)**
* 性能优化和内存管理改进
* 无障碍功能开发
* 多语言支持基础框架
* 全面测试和bug修复

**技术栈选择:**

**前端技术:**
* 现有: HTML5 + CSS3 + Vanilla JavaScript
* 新增: 考虑引入轻量级状态管理 (如Zustand)
* 主题系统: CSS自定义属性 + JavaScript动态切换

**后端技术:**
* 服务器: Node.js + Express
* 数据库: MongoDB (文档型，适合场景数据存储)
* 认证: JWT + bcrypt
* 文件存储: AWS S3 或 阿里云OSS (场景文件)

**开发工具:**
* 版本控制: Git + GitHub
* 项目管理: GitHub Projects
* 测试: Jest (单元测试) + Playwright (E2E测试)
* 部署: Vercel (前端) + Railway/Heroku (后端)

**质量保证:**
* 代码审查: 所有代码变更需要审查
* 自动化测试: 单元测试覆盖率 > 80%
* 性能监控: 集成性能监控工具
* 用户测试: 定期进行用户可用性测试